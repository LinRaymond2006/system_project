%INCLUDE "LDR_CFG.INC"
%DEFINE TMP_PAGE_TABLE_BASE (0X90000)

%DEFINE DATASZ32 DB 0X66
%DEFINE DATASZ64 DB 0X66
[BITS 16]
[ORG BUFFERBASE]
;DISK_PACKET: 0X500~0X700 (DISK_PACKET_SIZE:0X10)
;MEM_STRUCT: 0X7C00~0X7E00 (MEM_STRUCT_SIZE:0X200)
;MEM_STRUCT WILL OVERWRITE MASTER BOOT RECORD
;VBE_STRUCT:
%DEFINE MEM_STRUCT_BASE 0X7C00


INIT:
    MOV SP, 0X7C00      ;RESET THE STACK
    MOV AX, 0XB800
    MOV GS, AX      ;TMP TEXT FRAME BUFFER SEGMENT REGISTER
    CALL DO_CLEAR_SCR
    CALL DO_DISABLE_CURSOR

%DEFINE SMAP_MAGIC 0X534D4150



START_GET_MEM_STRUCT:
    XOR EBX, EBX
    MOV ES, BX      ;ES=0 (STRUCTURE ADDRESS: 0X0000:0X0700 )
    MOV DI, MEM_STRUCT_BASE

    .GET_MEM_STRUCT_LOOP:
        MOV EAX, DWORD 0XE820
        MOV ECX, DWORD 20
        MOV EDX, DWORD SMAP_MAGIC
        INT 0X15
        JC .GET_MEM_STRUCT_FAILED
        INC BYTE [MEM_STRUCT_COUNT]
        ADD DI, 20
        CMP EBX, 0
        JNE .GET_MEM_STRUCT_LOOP
        JMP .GET_MEM_STRUCT_DONE
    .GET_MEM_STRUCT_FAILED:
        ;AH=ERROR CODE (0X80:INVALID COMMAND;0X86 = "E820 NOT SUPPORTED" )
        JMP $       ;HALT FOR NOW, TAKE FURTHER ACTION IN FUTURE (PRINT LOG)
    .GET_MEM_STRUCT_DONE:

DO_ENABLE_A20_FASTGATE:
	IN AL, 0X92
	OR AL, 00000010B
	OUT 0X92, AL



SETUP_PMODE:

    DATASZ32
    LGDT [GDT32PTR]

    DATASZ32
    LIDT [IDT32PTR]
    MOV EAX, CR0
    OR EAX, 1
    MOV CR0, EAX
    JMP DWORD SELECTOR_CODE32:PMODE_ENTRY

[BITS 32]

PMODE_ENTRY:
	mov	ax,	0x10
	mov	ds,	ax
	mov	es,	ax
	mov	fs,	ax
	mov	ss,	ax
	mov	esp,	0x7c00

DETECT_CPUID_SUPPORT:
    PUSHFD
    POP EAX
    MOV ECX, EAX
    XOR EAX, 0X200000
    PUSH EAX
    POPFD
    PUSHFD
    POP EAX
    XOR EAX, ECX
    JZ CPUID_NOT_SUPPORTED
%DEFINE CPUID_LM (1 << 29)
DETECT_LONG_MODE_SUPPORT:
    ;REFERENCE:https://wiki.osdev.org/Setting_Up_Long_Mode
    MOV EAX, 0X80000000
    CPUID
    CMP EAX, 0X80000001
    JB LONG_MODE_NOT_SUPPORT
    MOV EAX, 0X80000001
    CPUID
    TEST EDX, CPUID_LM
    JZ LONG_MODE_NOT_SUPPORT
SETUP_LONGMODE_DEPS:

;THE FOLLOWING CODE WHICH SETUP DEPENDENCY FOR LONG MODE
;IS MOSTLY CLONED FROM ISBN 9787115475251
LOAD_TMP_PAGE_TABLE:
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X0],0X91007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X4],0X00000
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X800],0X91007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X804],0X00000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X1000],0X92007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X1004],0X00000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2000],0X000083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2004],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2008],0X200083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X200C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2010],0X400083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2014],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2018],0X600083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X201C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2020],0X800083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2024],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2028],0XA00083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X202C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


FLUSH_DESCRIPTOR:
    DATASZ64
	LGDT [GDT64PTR]
	MOV	AX, 0x10
	MOV	DS,	AX
	MOV	ES,	AX
	MOV	FS,	AX
	MOV	GS,	AX
	MOV	SS,	AX


ENABLE_PAE:
	MOV	EAX, CR4
	BTS	EAX, 5
	MOV	CR4, EAX

LOAD_PAGE_TABLE:
	MOV	EAX, TMP_PAGE_TABLE_BASE
	MOV	CR3, EAX

GO_TO_LONG_MODE:
	MOV	ECX, 0x0C0000080
	RDMSR
	BTS	EAX,	8
	WRMSR

TRANSFER_TO_KERNEL:
    ;JMP	SELECTOR_CODE64:test64

STOP:
    JMP $

[BITS 64]
test64:
    jmp $

[SECTION DATA]
MEM_STRUCT_COUNT: DB 0
WORD_PRINTED: DW 0
CURSOR_PTR: DW 0

[SECTION .STRINGS]

;END OF STRING
%DEFINE EOS (0X00)
%DEFINE CHAR_SPEC_N 10
%DEFINE CHAR_SPEC_B 8

LOG_CPUID_NOT_SUPPORTED: DB "INSTRUCTION 'CPUID' NOT SUPPORTED, HALT", CHAR_SPEC_N,"INSTRUCTION 'CPUID' NOT SUPPORTED, HALT", CHAR_SPEC_N, EOS
LOG_LONG_MODE_NOT_SUPPORTED: DB "CPUID.LM CLEARED, HALT", EOS

[SECTION .GDT]

LABEL_GDT32:  DD 0,0
LABEL_DESCRIPTOR_CODE32:    DD 0X0000FFFF, 0X00CF9A00
LABEL_DESCRIPTOR_DATA32:    DD 0X0000FFFF, 0X00CF9200
LABLE_GDT32_END:
GDT32LEN    EQU     (LABLE_GDT32_END - LABEL_GDT32)
GDT32LIM    EQU     (GDT32LEN-1)
GDT32PTR:
    DW GDT32LIM
    DD LABEL_GDT32
SELECTOR_CODE32 EQU     (LABEL_DESCRIPTOR_CODE32-LABEL_GDT32)
SELECTOR_DATA32 EQU     (LABEL_DESCRIPTOR_DATA32-LABEL_GDT32)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
LABEL_GDT64:DQ 0X0000000000000000
LABEL_DESCRIPTOR_CODE64:    DQ 0X0020980000000000
LABEL_DESCRIPTOR_DATA64:    DQ 0X0000920000000000
LABLE_GDT64_END:
GDT64LEN    EQU     (LABLE_GDT64_END-LABEL_GDT64)
GDT64LIM    EQU     (GDT64LEN-1)
GDT64PTR:
    DW GDT64LIM
    DD LABEL_GDT64
SELECTOR_CODE64 EQU (LABEL_DESCRIPTOR_CODE64-LABEL_GDT64)
SELECTOR_DATA64 EQU (LABEL_DESCRIPTOR_DATA64-LABEL_GDT64)


[SECTION .IDT]
LABEL_IDT32:
    TIMES 0X50 DQ 0
LABEL_IDT32_END:
IDT32LEN    EQU     (LABEL_IDT32_END - LABEL_IDT32)
IDT32LIM    EQU     (IDT32LEN-1)
IDT32PTR:
    DW IDT32LIM
    DD LABEL_IDT32

[BITS 32]
[SECTION EXCEPTIONS]
%DEFINE DEFAULT_STYLE (0X7)
CPUID_NOT_SUPPORTED:
    MOV EAX, LOG_CPUID_NOT_SUPPORTED
    MOV EBX, DEFAULT_STYLE
    ;CALL DISPLAY_TEXT32
    JMP $
LONG_MODE_NOT_SUPPORT:
    MOV EAX, LOG_LONG_MODE_NOT_SUPPORTED
    MOV EBX, DEFAULT_STYLE
    ;CALL DISPLAY_TEXT32
    JMP $

;[SECTION TMP_PAGE_TABLE]


[SECTION SUBROUTINE]

%INCLUDE "LOADER_LIB.INC"
