%INCLUDE "LDR_CFG.INC"
[BITS 16]
[ORG BUFFERBASE]
;DISK_PACKET: 0X500~0X700 (DISK_PACKET_SIZE:0X10)
;MEM_STRUCT: 0X7C00~0X7E00 (MEM_STRUCT_SIZE:0X200)
;MEM_STRUCT WILL OVERWRITE MASTER BOOT RECORD
;VBE_STRUCT: 
%DEFINE MEM_STRUCT_BASE 0X7C00


INIT:
    MOV SP, 0X7C00      ;RESET THE STACK
    MOV AX, 0XB800
    MOV GS, AX      ;TMP TEXT FRAME BUFFER SEGMENT REGISTER
    CALL DO_CLEAR_SCR

%DEFINE SMAP_MAGIC 0X534D4150


;;;;;;;;;;;NOT WORKING!!!;;;;;;;;;;;;

START_GET_MEM_STRUCT:
    XOR EBX, EBX
    MOV ES, BX      ;ES=0 (STRUCTURE ADDRESS: 0X0000:0X0700 )
    MOV DI, MEM_STRUCT_BASE

    .GET_MEM_STRUCT_LOOP:
        MOV EAX, DWORD 0XE820
        MOV ECX, DWORD 20
        MOV EDX, DWORD SMAP_MAGIC
        INT 0X15
        JC .GET_MEM_STRUCT_FAILED
        INC BYTE [MEM_STRUCT_COUNT]
        ADD DI, 20
        CMP EBX, 0
        JNE .GET_MEM_STRUCT_LOOP
        JMP .GET_MEM_STRUCT_DONE
    .GET_MEM_STRUCT_FAILED:
        ;AH=ERROR CODE (0X80:INVALID COMMAND;0X86 = "E820 NOT SUPPORTED" )
        JMP $       ;HALT FOR NOW, TAKE FURTHER ACTION IN FUTURE (PRINT LOG)
    .GET_MEM_STRUCT_DONE:

;MODIFIED FROM HTTPS://WIKI.OSDEV.ORG/UNREAL_MODE
DO_ENABLE_UNREAL_MODE:

	CLI                    ; NO INTERRUPTS
	PUSH DS                ; SAVE REAL MODE

	LGDT [GDT16_PTR]         ; LOAD GDT REGISTER

	MOV  EAX, CR0          ; SWITCH TO PMODE BY
	OR AL,1                ; SET PMODE BIT
	MOV  CR0, EAX

	JMP $+2                ; TELL 386/486 TO NOT CRASH

	MOV  BX, 0X08          ; SELECT DESCRIPTOR 1
	MOV  DS, BX            ; 8H = 1000B

	AND AL,0XFE            ; BACK TO REALMODE
	MOV  CR0, EAX          ; BY TOGGLING BIT AGAIN

	POP DS                 ; GET BACK OLD SEGMENT
	STI

;DETECT VBE INFORMATION NOW
DETECT_VBE_INFORMATION:



JMP $

[SECTION .DATA]
MEM_STRUCT_COUNT: DB 0

[SECTION .GDT16]
GDT16_PTR:
	DW GDT16_END - GDT16 - 1   ;LAST BYTE IN TABLE
	DD GDT16                 ;START OF TABLE
GDT16         DD 0,0        ; ENTRY 0 IS ALWAYS UNUSED
FLATDESC16    DB 0XFF, 0XFF, 0, 0, 0, 10010010B, 11001111B, 0
GDT16_END:


;LOAD VBE MODE INFORMATION AFTER THE GDT IS LOADED (UNDER REAL MODE)

[SECTION .SUBROUTINE]

%INCLUDE "LOADER_LIB.INC"