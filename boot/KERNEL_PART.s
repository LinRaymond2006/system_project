[BITS 32]
DETECT_CPUID_SUPPORT:
    PUSHFD
    POP EAX
    MOV ECX, EAX
    XOR EAX, 0X200000
    PUSH EAX
    POPFD
    PUSHFD
    POP EAX
    XOR EAX, ECX
    JZ CPUID_NOT_SUPPORTED
%DEFINE CPUID_LM (1 << 29)
DETECT_LONG_MODE_SUPPORT:
    ;REFERENCE:https://wiki.osdev.org/Setting_Up_Long_Mode
    MOV EAX, 0X80000000
    CPUID
    CMP EAX, 0X80000001
    JB LONG_MODE_NOT_SUPPORT
    MOV EAX, 0X80000001
    CPUID
    TEST EDX, CPUID_LM
    JZ LONG_MODE_NOT_SUPPORT
SETUP_LONGMODE_DEPS:

;THE FOLLOWING CODE WHICH SETUP DEPENDENCY FOR LONG MODE
;IS MOSTLY CLONED FROM ISBN 9787115475251
LOAD_TMP_PAGE_TABLE:
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X0],0X91007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X4],0X00000
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X800],0X91007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X804],0X00000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X1000],0X92007
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X1004],0X00000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2000],0X000083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2004],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2008],0X200083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X200C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2010],0X400083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2014],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2018],0X600083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X201C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2020],0X800083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2024],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X2028],0XA00083
    MOV	DWORD [TMP_PAGE_TABLE_BASE+0X202C],0X000000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


FLUSH_DESCRIPTOR:
    DATASZ64
	LGDT [GDT64PTR]
	MOV	AX, 0x10
	MOV	DS,	AX
	MOV	ES,	AX
	MOV	FS,	AX
	MOV	GS,	AX
	MOV	SS,	AX


ENABLE_PAE:
	MOV	EAX, CR4
	BTS	EAX, 5
	MOV	CR4, EAX

LOAD_PAGE_TABLE:
	MOV	EAX, TMP_PAGE_TABLE_BASE
	MOV	CR3, EAX

GO_TO_LONG_MODE:
	MOV	ECX, 0x0C0000080
	RDMSR
	BTS	EAX,	8
	WRMSR

TRANSFER_TO_KERNEL:
    ;JMP	SELECTOR_CODE64:test64

STOP:
    JMP $












LABEL_GDT64:DQ 0X0000000000000000
LABEL_DESCRIPTOR_CODE64:    DQ 0X0020980000000000
LABEL_DESCRIPTOR_DATA64:    DQ 0X0000920000000000
LABLE_GDT64_END:
GDT64LEN    EQU     (LABLE_GDT64_END-LABEL_GDT64)
GDT64LIM    EQU     (GDT64LEN-1)
GDT64PTR:
    DW GDT64LIM
    DD LABEL_GDT64
SELECTOR_CODE64 EQU (LABEL_DESCRIPTOR_CODE64-LABEL_GDT64)
SELECTOR_DATA64 EQU (LABEL_DESCRIPTOR_DATA64-LABEL_GDT64)

[BITS 32]
[SECTION EXCEPTIONS]
%DEFINE DEFAULT_STYLE (0X7)
CPUID_NOT_SUPPORTED:
    ;MOV EAX, LOG_CPUID_NOT_SUPPORTED
    ;MOV EBX, DEFAULT_STYLE
    ;CALL DISPLAY_TEXT32
    JMP $
LONG_MODE_NOT_SUPPORT:
    ;MOV EAX, LOG_LONG_MODE_NOT_SUPPORTED
    ;MOV EBX, DEFAULT_STYLE
    ;CALL DISPLAY_TEXT32
    JMP $